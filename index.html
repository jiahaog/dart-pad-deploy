<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>DartPad Client Compiler POC â€“ Flutter Preview</title>
    <script src="require.js"></script>
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: system-ui, -apple-system, sans-serif; display: flex; height: 100vh; }
      #editor-pane { flex: 1; display: flex; flex-direction: column; padding: 1rem; border-right: 1px solid #ccc; }
      #right-pane { flex: 1; display: flex; flex-direction: column; }
      #preview-pane { flex: 1; border-bottom: 1px solid #ccc; position: relative; }
      #preview-frame { width: 100%; height: 100%; border: none; }
      #output-pane { flex: 1; display: flex; flex-direction: column; padding: 1rem; }
      textarea { flex: 1; padding: 0.5rem; font-family: monospace; border: 1px solid #ccc; }
      button { padding: 0.5rem 1rem; margin: 0.5rem 0; cursor: pointer; background: #007acc; color: white; border: none; border-radius: 4px; }
      button:disabled { background: #999; cursor: not-allowed; }
      button:hover:not(:disabled) { background: #005a9e; }
      #output { flex: 1; border: 1px solid #ccc; padding: 0.5rem; background: #f5f5f5; font-family: monospace; font-size: 12px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; }
      .error { color: #d32f2f; }
      .success { color: #388e3c; }
      h3 { margin-bottom: 0.5rem; }
    </style>
    <script>
      require.config({ baseUrl: "./assets", waitSeconds: 120 });
      require(["dart_sdk"], function () {
        var s = document.createElement("script");
        s.src = "./compiler_bundle.js";
        document.head.appendChild(s);
      });

      function runCode() {
        if (!window.compileFlutter) {
          appendOutput('Error: Compiler not loaded yet. Please wait...', 'error');
          return;
        }
        var btn = document.getElementById('run-btn');
        btn.disabled = true;
        btn.textContent = 'Compiling...';

        var code = document.getElementById('code').value;
        document.getElementById('output').innerHTML = '';

        window.compileFlutter(code);
      }

      window.onFlutterCompileResult = function(jsCode, moduleName) {
        appendOutput('Compilation succeeded. Loading Flutter preview...', 'success');
        setPreviewContent(jsCode, moduleName);

        var btn = document.getElementById('run-btn');
        btn.disabled = false;
        btn.textContent = 'Run';
      };

      function setPreviewContent(jsCode, moduleName) {
        var oldIframe = document.getElementById('preview-frame');
        var container = document.getElementById('preview-pane');
        oldIframe.remove();

        var iframe = document.createElement('iframe');
        iframe.id = 'preview-frame';
        container.appendChild(iframe);

        // Build a blob script that sets up require, loads AMD modules,
        // injects the compiled code, and calls bootstrap.main().
        // This blob is passed to _flutter.loader.loadEntrypoint() so the
        // Flutter engine is properly initialized before runApp().
        var blobScript =
          'require.config({ baseUrl: "./assets", waitSeconds: 120 });\n' +
          'require.undef("' + moduleName + '");\n' +
          '\n' +
          'require(["dart_sdk", "flutter_web"], function(dart_sdk, flutter_web) {\n' +
          '  dart_sdk.dart.setStartAsyncSynchronously(true);\n' +
          '  dart_sdk._isolate_helper.startRootIsolate(function() {}, []);\n' +
          '  dart_sdk._debugger.registerDevtoolsFormatter();\n' +
          '\n' +
          '  var userCode = ' + JSON.stringify(jsCode) + ';\n' +
          '  var script = document.createElement("script");\n' +
          '  script.text = userCode;\n' +
          '  document.head.appendChild(script);\n' +
          '\n' +
          '  require(["' + moduleName + '"], function(module) {\n' +
          '    var mainLib = module.project__bootstrap || module.project__main || module.main;\n' +
          '    if (mainLib && mainLib.main) {\n' +
          '      mainLib.main();\n' +
          '    }\n' +
          '  });\n' +
          '});\n';

        var doc = iframe.contentDocument;
        doc.open();
        doc.write(
          '<!doctype html>\n<html>\n<head>\n<meta charset="utf-8">\n' +
          '<style>html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }</style>\n' +
          '<script src="./require.js"></' + 'script>\n' +
          '<script src="./assets/flutter.js"></' + 'script>\n' +
          '</head>\n<body>\n' +
          '<script>\n' +
          'var blob = new Blob([' + JSON.stringify(blobScript) + '], { type: "text/javascript" });\n' +
          'var blobUrl = URL.createObjectURL(blob);\n' +
          '_flutter.loader.loadEntrypoint({\n' +
          '  entrypointUrl: blobUrl,\n' +
          '  onEntrypointLoaded: async function(engineInitializer) {\n' +
          '    var appRunner = await engineInitializer.initializeEngine({\n' +
          '      canvasKitBaseUrl: "./assets/canvaskit/"\n' +
          '    });\n' +
          '    appRunner.runApp();\n' +
          '    window.parent.postMessage({ type: "flutter-ready" }, "*");\n' +
          '  }\n' +
          '});\n' +
          '</' + 'script>\n' +
          '</body>\n</html>'
        );
        doc.close();
      }

      function appendOutput(text, cls) {
        var output = document.getElementById('output');
        var span = document.createElement('span');
        if (cls) span.className = cls;
        span.textContent = text + '\n';
        output.appendChild(span);
      }

      // Callback when compiler is ready
      window.onDartCompilerReady = function() {
        document.getElementById('output').innerHTML =
          '<span class="success">Compiler ready.</span>\n';
        var btn = document.getElementById('run-btn');
        btn.disabled = false;
        btn.textContent = 'Run';
      };

      // Monitor console.log to capture compiler and program output
      (function() {
        var origLog = console.log;
        console.log = function() {
          origLog.apply(console, arguments);
          var msg = Array.prototype.slice.call(arguments).join(' ');
          var output = document.getElementById('output');
          if (output) {
            if (msg.indexOf('[compiler-poc]') === 0) {
              if (msg.indexOf('ERROR') !== -1) {
                appendOutput(msg, 'error');
                var btn = document.getElementById('run-btn');
                btn.disabled = false;
                btn.textContent = 'Run';
              }
            } else {
              appendOutput(msg, '');
            }
          }
        };
      })();

      // Listen for messages from the preview iframe
      window.addEventListener('message', function(e) {
        if (e.data && e.data.type === 'flutter-error') {
          appendOutput('Preview error: ' + e.data.message, 'error');
        } else if (e.data && e.data.type === 'flutter-ready') {
          appendOutput('Flutter app started.', 'success');
        }
      });
    </script>
  </head>
  <body>
    <div id="editor-pane">
      <h3>Dart Code</h3>
      <textarea id="code">import 'package:flutter/material.dart';

void main() {
  runApp(
    MaterialApp(
      home: Scaffold(
        appBar: AppBar(title: Text('Hello Flutter')),
        body: Center(
          child: Text(
            'hello from browser-compiled Flutter!',
            style: TextStyle(fontSize: 24),
          ),
        ),
      ),
    ),
  );
}
</textarea>
      <button id="run-btn" onclick="runCode()" disabled>Loading compiler...</button>
    </div>
    <div id="right-pane">
      <div id="preview-pane">
        <iframe id="preview-frame"></iframe>
      </div>
      <div id="output-pane">
        <h3>Output</h3>
        <div id="output">Loading compiler...</div>
      </div>
    </div>
  </body>
</html>
