<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>DartPad Offline Experiment</title>
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: system-ui, -apple-system, sans-serif; display: flex; height: 100vh; }
      #editor-pane { flex: 1; display: flex; flex-direction: column; padding: 1rem; border-right: 1px solid #ccc; }
      #right-pane { flex: 1; display: flex; flex-direction: column; }
      #preview-pane { flex: 1; border-bottom: 1px solid #ccc; position: relative; }
      #preview-frame { width: 100%; height: 100%; border: none; }
      #output-pane { flex: 1; display: flex; flex-direction: column; padding: 1rem; }
      textarea { flex: 1; padding: 0.5rem; font-family: monospace; border: 1px solid #ccc; }
      button { padding: 0.5rem 1rem; margin: 0.5rem 0; cursor: pointer; background: #007acc; color: white; border: none; border-radius: 4px; }
      button:disabled { background: #999; cursor: not-allowed; }
      button:hover:not(:disabled) { background: #005a9e; }
      .toggle-container { display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0; font-size: 14px; }
      .toggle-switch { position: relative; width: 36px; height: 20px; }
      .toggle-switch input { opacity: 0; width: 0; height: 0; }
      .toggle-switch .slider { position: absolute; inset: 0; background: #ccc; border-radius: 20px; cursor: pointer; transition: background 0.2s; }
      .toggle-switch .slider::before { content: ""; position: absolute; left: 2px; top: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: transform 0.2s; }
      .toggle-switch input:checked + .slider { background: #007acc; }
      .toggle-switch input:checked + .slider::before { transform: translateX(16px); }
      #output { flex: 1; border: 1px solid #ccc; padding: 0.5rem; background: #f5f5f5; font-family: monospace; font-size: 12px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; }
      .error { color: #d32f2f; }
      .success { color: #388e3c; }
      h3 { margin-bottom: 0.5rem; }
      #offline-indicator { position: fixed; bottom: 1rem; right: 1rem; padding: 0.75rem 1.5rem; background: #333; color: white; border-radius: 4px; font-size: 14px; z-index: 1000; display: none; }
      #offline-indicator.loading { display: block; background: #ff9800; }
      #offline-indicator.ready { display: block; background: #4caf50; }
      #offline-indicator::before { content: "⏳"; margin-right: 0.5rem; }
      #offline-indicator.ready::before { content: "✓"; margin-right: 0.5rem; }
    </style>
    <style id="preview-mode-style"></style>
    <script>
      var _previewMode = false;
      (function() {
        var hash = window.location.hash;
        if (hash.indexOf('#preview=') === 0) {
          _previewMode = true;
          document.getElementById('preview-mode-style').textContent =
            '#editor-pane, #output-pane { display: none !important; }' +
            'body { display: block !important; }' +
            '#right-pane { width: 100%; height: 100vh; }' +
            '#preview-pane { height: 100%; border-bottom: none; }';
        }
      })();

      if ("serviceWorker" in navigator && !_previewMode) {
        window.addEventListener("load", function() {
          showOfflineIndicator("Setting up for offline...");
          navigator.serviceWorker.register("./service-worker.js").then(function() {
            if (navigator.serviceWorker.controller) {
              showOfflineIndicator("Ready for offline", true);
            }
          }).catch(function(err) {
            console.warn("Service worker registration failed", err);
          });
        });
        navigator.serviceWorker.addEventListener("message", function(event) {
          if (event.data && event.data.type === "sw-ready") {
            showOfflineIndicator("Ready for offline", true);
          }
        });
      }

      function showOfflineIndicator(text, isReady) {
         var indicator = document.getElementById('offline-indicator');
         if (!indicator) {
           indicator = document.createElement('div');
           indicator.id = 'offline-indicator';
           document.body.appendChild(indicator);
         }
         indicator.textContent = text;
         indicator.className = isReady ? 'ready' : 'loading';
         
         if (isReady) {
           setTimeout(function() {
             indicator.style.display = 'none';
           }, 3000);
         }
       }

      var _compilerWorker = new Worker('./compiler_worker.js');
      var _compilerReady = false;
      var _engineReady = false;

      (function() {
        var assetsBase = new URL('./assets/', window.location.href).toString();
        _compilerWorker.postMessage({ type: 'init', assetsBase: assetsBase });
      })();

      _compilerWorker.onmessage = function(e) {
        var data = e.data;
        if (data.type === 'ready') {
          _compilerReady = true;
          console.log('[compiler-poc] Compiler ready');
          document.getElementById('output').innerHTML = '';
          var btn = document.getElementById('run-btn');
          btn.disabled = false;
          btn.textContent = 'Run';

          if (_previewMode) {
            var hash = window.location.hash;
            var encoded = hash.substring('#preview='.length);
            var code = decodeURIComponent(encoded);
            document.getElementById('code').value = code;
          }

          runCode();
        } else if (data.type === 'compileResult') {
          console.log('[compiler-poc] JS output length: ' + data.jsCode.length + ' chars');
          handleCompileResult(data.jsCode, data.moduleName);
        } else if (data.type === 'compileError') {
          handleCompileError(data.errors);
        }
      };

      function runCode() {
         if (!_compilerReady) {
           appendOutput('Error: Compiler not loaded yet. Please wait...', 'error');
           return;
         }
         var btn = document.getElementById('run-btn');
         btn.disabled = true;

         var code = document.getElementById('code').value;
         document.getElementById('output').innerHTML = '';

         _compilerWorker.postMessage({ type: 'compileFlutter', source: code });
       }

      function handleCompileError(errorMessages) {
        for (var i = 0; i < errorMessages.length; i++) {
          appendOutput(errorMessages[i], 'error');
        }
        var btn = document.getElementById('run-btn');
        btn.disabled = false;
        btn.textContent = 'Run';
      }

      function handleCompileResult(jsCode, moduleName) {
        var iframe = document.getElementById('preview-frame');

        if (_engineReady) {
          iframe.contentWindow.postMessage({
            type: 'flutter-swap',
            jsCode: jsCode,
            moduleName: moduleName
          }, '*');
        } else {
          sendToPreview('flutter-run', jsCode, moduleName);
        }

        var btn = document.getElementById('run-btn');
        btn.disabled = false;
        btn.textContent = 'Run';
      }

      function sendToPreview(type, jsCode, moduleName) {
         var iframe = document.getElementById('preview-frame');

         if (_previewReady) {
           _previewReady = false;
           iframe.contentWindow.postMessage({
             type: type,
             jsCode: jsCode,
             moduleName: moduleName
           }, '*');
         } else {
           _pendingMessage = { type: type, jsCode: jsCode, moduleName: moduleName };
         }
       }

      var _previewReady = false;
      var _pendingMessage = null;

      function buildShareUrl() {
        var code = document.getElementById('code').value;
        var encoded = encodeURIComponent(code);
        return window.location.origin + window.location.pathname + '#preview=' + encoded;
      }

      function shareCode() {
        var url = buildShareUrl();
        navigator.clipboard.writeText(url).then(function() {
          var btn = document.getElementById('share-btn');
          btn.textContent = 'Copied!';
          setTimeout(function() { btn.textContent = 'Share'; }, 2000);
        });
      }

      function appendOutput(text, cls) {
        var output = document.getElementById('output');
        var span = document.createElement('span');
        if (cls) span.className = cls;
        span.textContent = text + '\n';
        output.appendChild(span);
      }

      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('code').addEventListener('input', function() {
          if (!document.getElementById('auto-compile-toggle').checked) return;
          if (!document.getElementById('run-btn').disabled) {
            runCode();
          }
        });
      });

      window.addEventListener('message', function(e) {
        if (e.data && e.data.type === 'preview-ready') {
          var iframe = document.getElementById('preview-frame');
          if (e.source === iframe.contentWindow) {
            _previewReady = true;
            console.log('[compiler-poc] preview-ready');
            if (_pendingMessage) {
              var msg = _pendingMessage;
              _pendingMessage = null;
              _previewReady = false;
              iframe.contentWindow.postMessage(msg, '*');
            }
          }
        } else if (e.data && e.data.type === 'console-log') {
          appendOutput(e.data.message);
        } else if (e.data && e.data.type === 'console-error') {
          appendOutput(e.data.message, 'error');
        } else if (e.data && e.data.type === 'flutter-error') {
          appendOutput('Preview error: ' + e.data.message, 'error');
        } else if (e.data && e.data.type === 'flutter-ready') {
          _engineReady = true;
          console.log('[compiler-poc] Flutter app started');
        } else if (e.data && e.data.type === 'sw-ready') {
          console.log('sw-ready');
        }
      });
    </script>
  </head>
  <body>
    <div id="editor-pane">
      <h3>go/dartpad-offline</h3>
      <textarea id="code">import 'package:flutter/material.dart';

void main() {
  runApp(
    MaterialApp(
      home: Scaffold(
        appBar: AppBar(title: Text('Hello Flutter')),
        body: Center(
          child: Text(
            'hello from browser-compiled Flutter!',
            style: TextStyle(fontSize: 24),
          ),
        ),
      ),
    ),
  );
}
</textarea>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <button id="run-btn" onclick="runCode()" disabled>Loading compiler...</button>
        <button id="share-btn" onclick="shareCode()">Share</button>
        <label class="toggle-container">
          <span class="toggle-switch">
            <input type="checkbox" id="auto-compile-toggle" checked>
            <span class="slider"></span>
          </span>
          Auto-compile
        </label>
      </div>
    </div>
    <div id="right-pane">
      <div id="preview-pane">
        <iframe id="preview-frame" src="./preview.html"></iframe>
      </div>
      <div id="output-pane">
        <h3>Output</h3>
        <div id="output">Loading compiler...</div>
      </div>
    </div>
  </body>
</html>
