<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Flutter Preview</title>
    <style>
      html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
    </style>
    <script src="./require.js"></script>
    <script src="./assets/flutter.js"></script>
    <script>
      window.addEventListener('load', function() {
        console.log('preview-ready');
        window.parent.postMessage({ type: 'preview-ready' }, '*');
      });

      window.addEventListener('message', function(event) {
        if (!event.data || event.data.type !== 'flutter-run') {
          return;
        }

        if (!window.__flutterPreview) {
          window.__flutterPreview = { lastRunId: 0, started: false };
        }

        window.__flutterPreview.lastRunId += 1;
        var runId = window.__flutterPreview.lastRunId;
        window.__flutterPreview.started = false;

        var jsCode = event.data.jsCode;
        var moduleName = event.data.moduleName;

        var blobScript =
          'require.config({ baseUrl: "./assets", waitSeconds: 120 });\n' +
          'require.undef("' + moduleName + '");\n' +
          '\n' +
          'require(["dart_sdk", "flutter_web"], function(dart_sdk, flutter_web) {\n' +
          '  dart_sdk.dart.setStartAsyncSynchronously(true);\n' +
          '  dart_sdk._isolate_helper.startRootIsolate(function() {}, []);\n' +
          '  dart_sdk._debugger.registerDevtoolsFormatter();\n' +
          '\n' +
          '  var userCode = ' + JSON.stringify(jsCode) + ';\n' +
          '  var script = document.createElement("script");\n' +
          '  script.text = userCode;\n' +
          '  document.head.appendChild(script);\n' +
          '\n' +
          '  require(["' + moduleName + '"], function(module) {\n' +
          '    var mainLib = module.project__bootstrap || module.project__main || module.main;\n' +
          '    if (mainLib && mainLib.main) {\n' +
          '      mainLib.main();\n' +
          '    }\n' +
          '  });\n' +
          '});\n';

        var blob = new Blob([blobScript], { type: "text/javascript" });
        var blobUrl = URL.createObjectURL(blob);
        _flutter.loader.loadEntrypoint({
          entrypointUrl: blobUrl,
          onEntrypointLoaded: async function(engineInitializer) {
            var appRunner = await engineInitializer.initializeEngine({
              canvasKitBaseUrl: "./assets/canvaskit/"
            });
            appRunner.runApp();
            if (window.__flutterPreview.lastRunId === runId && !window.__flutterPreview.started) {
              window.__flutterPreview.started = true;
              window.parent.postMessage({ type: "flutter-ready" }, "*");
            }
          }
        });
      });
    </script>
  </head>
  <body></body>
</html>
