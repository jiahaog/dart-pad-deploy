<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Flutter Preview</title>
    <style>
      html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
    </style>
    <script src="./require.js"></script>
    <script src="./assets/flutter.js"></script>
    <script>
      window.addEventListener('load', function() {
        require.config({ baseUrl: "./assets", waitSeconds: 120 });

        require(["dart_sdk", "flutter_web"], function(dart_sdk, flutter_web) {
          console.log('preview: dart_sdk and flutter_web preloaded');

          dart_sdk.dart.setStartAsyncSynchronously(true);
          dart_sdk._isolate_helper.startRootIsolate(function() {}, []);
          dart_sdk._debugger.registerDevtoolsFormatter();

          window.parent.postMessage({ type: 'preview-ready' }, '*');
        });
      });

      window.addEventListener('message', function(event) {
        if (!event.data) return;

        if (event.data.type === 'flutter-run') {
          handleFlutterRun(event.data.jsCode, event.data.moduleName);
        } else if (event.data.type === 'flutter-swap') {
          handleFlutterSwap(event.data.jsCode, event.data.moduleName);
        }
      });

      function injectAndRequire(jsCode, moduleName, callback) {
        var cbName = '__mod_cb_' + Date.now();
        window[cbName] = function(module) {
          delete window[cbName];
          callback(module);
        };
        var script = document.createElement("script");
        script.text = jsCode + '\n' +
          'require(["' + moduleName + '"], window["' + cbName + '"]);\n';
        document.head.appendChild(script);
      }

      function handleFlutterRun(jsCode, moduleName) {
        var entrypointScript = jsCode + '\n' +
          'require.config({ baseUrl: "./assets", waitSeconds: 120 });\n' +
          'require(["' + moduleName + '"], function(module) {\n' +
          '  var mainLib = module.project__bootstrap || module.project__main || module.main;\n' +
          '  if (mainLib && mainLib.main) {\n' +
          '    mainLib.main();\n' +
          '  }\n' +
          '});\n';

        var blob = new Blob([entrypointScript], { type: "text/javascript" });
        var blobUrl = URL.createObjectURL(blob);
        _flutter.loader.loadEntrypoint({
          entrypointUrl: blobUrl,
          onEntrypointLoaded: async function(engineInitializer) {
            var appRunner = await engineInitializer.initializeEngine({
              canvasKitBaseUrl: "./assets/canvaskit/"
            });
            appRunner.runApp();
            window.parent.postMessage({ type: "flutter-ready" }, "*");
          }
        });
      }

      function handleFlutterSwap(jsCode, moduleName) {
        injectAndRequire(jsCode, moduleName, function(module) {
          var mainLib = module.project__main || module.main;
          if (mainLib && mainLib.main) {
            mainLib.main();
          }
          window.parent.postMessage({ type: "flutter-ready" }, "*");
        });
      }
    </script>
  </head>
  <body></body>
</html>
