<!doctype html>
<html>
<head>
<meta charset="utf-8">
<style>html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }</style>
<script src="./require.js"></script>
<script src="./assets/flutter.js"></script>
</head>
<body>
<script>
window.addEventListener('message', function(e) {
  if (e.data && e.data.type === 'run-flutter') {
    var jsCode = e.data.jsCode;
    var moduleName = e.data.moduleName;

    require.config({ baseUrl: "./assets", waitSeconds: 120 });
    require.undef(moduleName);

    var blobScript =
      'require.config({ baseUrl: "./assets", waitSeconds: 120 });\n' +
      'require.undef("' + moduleName + '");\n' +
      '\n' +
      'require(["dart_sdk", "flutter_web"], function(dart_sdk, flutter_web) {\n' +
      '  dart_sdk.dart.setStartAsyncSynchronously(true);\n' +
      '  dart_sdk._isolate_helper.startRootIsolate(function() {}, []);\n' +
      '  dart_sdk._debugger.registerDevtoolsFormatter();\n' +
      '\n' +
      '  var userCode = ' + JSON.stringify(jsCode) + ';\n' +
      '  var script = document.createElement("script");\n' +
      '  script.text = userCode;\n' +
      '  document.head.appendChild(script);\n' +
      '\n' +
      '  require(["' + moduleName + '"], function(module) {\n' +
      '    var mainLib = module.project__bootstrap || module.project__main || module.main;\n' +
      '    if (mainLib && mainLib.main) {\n' +
      '      mainLib.main();\n' +
      '    }\n' +
      '  });\n' +
      '});\n';

    var blob = new Blob([blobScript], { type: "text/javascript" });
    var blobUrl = URL.createObjectURL(blob);
    _flutter.loader.loadEntrypoint({
      entrypointUrl: blobUrl,
      onEntrypointLoaded: async function(engineInitializer) {
        var appRunner = await engineInitializer.initializeEngine({
          canvasKitBaseUrl: "./assets/canvaskit/"
        });
        appRunner.runApp();
        window.parent.postMessage({ type: "flutter-ready" }, "*");
      }
    });
  }
}, { once: true });

window.parent.postMessage({ type: 'preview-ready' }, '*');
</script>
</body>
</html>
